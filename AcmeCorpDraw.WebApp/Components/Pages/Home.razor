@page "/"
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Enter the Draw - Acme Corporation</PageTitle>

<div class="container my-5">
    <div class="d-flex flex-row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4">Acme Corporation Prize Draw</h1>
            <p>Enter for a chance to win! <strong>You can enter twice per valid serial number.</strong></p>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Error:</strong> @errorMessage
                    <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                </div>
            }

            @if (submissionSuccess)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <h4 class="alert-heading">Success!</h4>
                    <p>Your entry has been submitted successfully. Good luck!</p>
                    <hr>
                    @if (entriesUsedForSerial < 2)
                    {
                        <p class="mb-0">
                            <strong>Entries for this serial: @entriesUsedForSerial of 2</strong><br/>
                            You can submit one more entry with serial number <strong>@lastSubmittedSerial</strong>.
                        </p>
                    }
                    else
                    {
                        <p class="mb-0">
                            <strong>Maximum entries reached: 2 of 2</strong><br/>
                            You've used both entries for serial number <strong>@lastSubmittedSerial</strong>.
                        </p>
                    }
                    <button type="button" class="btn-close" @onclick="DismissSuccessMessage"></button>
                </div>
            }

            <EditForm Model="@submissionDto" OnValidSubmit="@HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary class="alert alert-warning" />

                <div class="mb-3">
                    <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
                    <InputText id="firstName" @bind-Value="submissionDto.FirstName" class="form-control" placeholder="Enter your first name" />
                    <ValidationMessage For="() => submissionDto.FirstName" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                    <InputText id="lastName" @bind-Value="submissionDto.LastName" class="form-control" placeholder="Enter your last name" />
                    <ValidationMessage For="() => submissionDto.LastName" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                    <InputText id="email" type="email" @bind-Value="submissionDto.Email" class="form-control" placeholder="your.email@example.com" />
                    <ValidationMessage For="() => submissionDto.Email" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="serialNumber" class="form-label">Product Serial Number <span class="text-danger">*</span></label>
                    <InputText id="serialNumber" @bind-Value="submissionDto.SerialNumber" class="form-control" placeholder="ACME-XXXX-XXXX-XXXX" />
                    <div class="form-text">Enter the serial number from your Acme Corporation product</div>
                    <ValidationMessage For="() => submissionDto.SerialNumber" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="dateOfBirth" class="form-label">Date of Birth <span class="text-danger">*</span></label>
                    <InputDate id="dateOfBirth" @bind-Value="submissionDto.DateOfBirth" class="form-control" />
                    <div class="form-text">You must be at least 18 years old to enter</div>
                    <ValidationMessage For="() => submissionDto.DateOfBirth" class="text-danger" />
                </div>

                <div class="d-flex flex-row gap-2">
                    <button type="submit" class="btn btn-primary btn-lg w-100" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Submitting...</span>
                        }
                        else
                        {
                            <span>Submit Entry</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private SubmissionDTO submissionDto { get; set; } = new SubmissionDTO();

    private bool isSubmitting = false;
    private bool submissionSuccess = false;
    private string? errorMessage;
    private int entriesUsedForSerial = 0;
    private string? lastSubmittedSerial;

    private async Task HandleValidSubmit()
    {
        if (isSubmitting)
        {
            return; // Prevent multiple submissions
        }

        isSubmitting = true;
        errorMessage = null;

        try
        {
            var baseUrl = Navigation.BaseUri;
            var apiUrl = $"{baseUrl}api/submissions";

            var response = await Http.PostAsJsonAsync(apiUrl, submissionDto);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<Response>();

                if (result?.Success == true && result.Submission != null)
                {
                    submissionSuccess = true;
                    lastSubmittedSerial = submissionDto.SerialNumber;

                    var countResponse = await Http.GetAsync($"{baseUrl}api/submissions/count/{submissionDto.SerialNumber}");
                    if (countResponse.IsSuccessStatusCode)
                    {
                        entriesUsedForSerial = await countResponse.Content.ReadFromJsonAsync<int>();
                    }
                }
            }
            else
            {
                var errorResponse = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = errorResponse?.Error ?? "An error occurred while submitting your entry.";
            }
        }
        catch (HttpRequestException)
        {
            errorMessage = "Unable to connect to the server. Please try again.";
        }
        catch (Exception)
        {
            errorMessage = "An unexpected error occurred. Please try again.";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void DismissSuccessMessage()
    {
        submissionSuccess = false;
    }

    private void ResetForm()
    {
        submissionDto = new SubmissionDTO();
        submissionSuccess = false;
        errorMessage = null;
        entriesUsedForSerial = 0;
        lastSubmittedSerial = null;
    }

    private class Response
    {
        public bool Success { get; set; }
        public Submission? Submission { get; set; }
        public string? ErrorMessage { get; set; }
    }

    private class ErrorResponse
    {
        public string? Error { get; set; }
    }
}